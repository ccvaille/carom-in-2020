### 前端监控系统
- 目的
  - 帮助及时定位和解决问题
  - 及时发现并减少线上问题的发生
  - 减少由事故带来的经济损失
- 组成
  - 日志采集
    - 针对日志的不同特点，进行分类处理
      - 错误日志
        - js 运行时错误，可通过 error 监听获取
        - 资源加载错误，可通过 error 监听获取
        - API 错误，可通过 Patch fetch / XMLHttpRequest 方法捕获
        - console 错误，可通过 Patch 方法捕获
        - Promise 错误，可通过 unhandledrejection 监听器捕获
        - 定位
          - 部署 js 到服务器上，将 sourcemap 文件上传到监控系统
          - 在监控系统展示错误信息时，利用 sourcemap 文件对错误堆栈信息进行解码，得到源码信息
        - 页面挂掉监控
          - Mutaion Observer 
          - 原理： 监控 dom 的渲染树
      - 性能日志
        - Timing Performance API 
        - 首屏加载时间统计
          - 监听页面 dom 结构的变化，根据设备视口的大小
          - 统计在视口内加载成功的最后一个 dom 元素的时间点
      - 产品指标日志
        - uv
          - distinct (ucid)
          - distinct (ip)
          - distinct (cookie)
        - pv（spa应用）
          - hash 路由
            - hashchange
          - history 路由
            - popState
          - vue && react 
            - 路由钩子
          - 外部 API 上报
      - 用户自定义打点日志
    - 对不同类型的日志，做公共字段的提取
      - 提升对数据的抽象程度，便于以后检索聚合分析操作，有利于节省存储空间
    - 重视对相关用户、设备环境的信息采集
      - 哪些用户在什么时间在哪里发生了什么
    - 提供给用户干预处理流程的 hook 能力
      - 提供用户对所要上报的数据进行过滤处理或者补充
    - 注意对于用户敏感数据的采集
      - 数据加密
      - 独立部署，不与其他应用共享监控系统
      - 不采集具体数据，只采集用户操作数据
  - 日志存储
    - 对日志的接收过程中，对内容进行合法性，安全性的校验，防止系统被恶意攻击
    - 频繁提交，一般会采用消息队列，比如 kafka 的方式将日志信息统一写入消息队列，后续通过消息消费服务来进行日志的校验和存储处理
    - 数据库
      - 关系型
        - 管理方便
        - 易于实现复杂查询
        - 存储容量相对较少
      - 非关系型
        - 性能高，储容量相对较大
  - 统计分析
    - 查询和筛选 elastic 
    - 用户维度
    - 时间维度
    - 运行环境维度
  - 监控告警
    - 日志包含指定内容
    - 日志达到一定量级
    - 向哪些用户告警
    - 推送
      - 邮件、短信、钉钉、电话